<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Hbase-进阶 | 哑舍</title><meta name="description" content="Hbase-进阶"><meta name="keywords" content="大数据"><meta name="author" content="Machine"><meta name="copyright" content="Machine"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/cat2.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hbase-进阶"><meta name="twitter:description" content="Hbase-进阶"><meta name="twitter:image" content="https://machine4869.gitee.io/img/default_p4.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="Hbase-进阶"><meta property="og:url" content="https://machine4869.gitee.io/2019/09/17/20190917204715525/"><meta property="og:site_name" content="哑舍"><meta property="og:description" content="Hbase-进阶"><meta property="og:image" content="https://machine4869.gitee.io/img/default_p4.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://machine4869.gitee.io/2019/09/17/20190917204715525/"><link rel="prev" title="Hbase-案例" href="https://machine4869.gitee.io/2019/10/08/20191008134811972/"><link rel="next" title="Hbase-入门" href="https://machine4869.gitee.io/2019/09/16/20190916095939630/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://machine4869.gitee.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">哑舍</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 豆瓣电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> 照片墙</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">134</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">27</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">45</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 豆瓣电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> 照片墙</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Hbase数据模型"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Hbase数据模型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Hbase逻辑结构"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">Hbase逻辑结构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Hbase物理存储结构"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">Hbase物理存储结构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#HBase数据结构"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">HBase数据结构</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#RowKey"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">RowKey</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Column-Family"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">Column Family</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Cell"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">Cell</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Time-Stamp"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">Time Stamp</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Name-Space"><span class="toc_mobile_items-number">1.3.5.</span> <span class="toc_mobile_items-text">Name Space</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#HBase原理"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">HBase原理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#写流程"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">写流程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#MemStore-Flush"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">MemStore Flush</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#读流程"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">读流程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#StoreFile-Compaction"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">StoreFile Compaction</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#读写扩展"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">读写扩展</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#数据真正删除的时间"><span class="toc_mobile_items-number">2.6.</span> <span class="toc_mobile_items-text">数据真正删除的时间</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Region-Split"><span class="toc_mobile_items-number">2.7.</span> <span class="toc_mobile_items-text">Region Split</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#HBase-API-操作"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">HBase API 操作</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#DDL-DML"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">DDL&#x2F;DML</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#与MapReduce交互"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">与MapReduce交互</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#环境配置"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">环境配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#官方案例"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">官方案例</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义-MR1"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">自定义-MR1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义-MR2"><span class="toc_mobile_items-number">4.4.</span> <span class="toc_mobile_items-text">自定义-MR2</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#与Hive集成"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">与Hive集成</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#HBase-与-Hive-的对比"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">HBase 与 Hive 的对比</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#环境准备"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">环境准备</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#案例一"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">案例一</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#案例二"><span class="toc_mobile_items-number">5.4.</span> <span class="toc_mobile_items-text">案例二</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#HBase优化"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">HBase优化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#高可用"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">高可用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#预分区"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">预分区</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#RowKey设计"><span class="toc_mobile_items-number">6.3.</span> <span class="toc_mobile_items-text">RowKey设计</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#内存-amp-其他"><span class="toc_mobile_items-number">6.4.</span> <span class="toc_mobile_items-text">内存&amp;其他</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hbase数据模型"><span class="toc-number">1.</span> <span class="toc-text">Hbase数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hbase逻辑结构"><span class="toc-number">1.1.</span> <span class="toc-text">Hbase逻辑结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hbase物理存储结构"><span class="toc-number">1.2.</span> <span class="toc-text">Hbase物理存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase数据结构"><span class="toc-number">1.3.</span> <span class="toc-text">HBase数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RowKey"><span class="toc-number">1.3.1.</span> <span class="toc-text">RowKey</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Column-Family"><span class="toc-number">1.3.2.</span> <span class="toc-text">Column Family</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cell"><span class="toc-number">1.3.3.</span> <span class="toc-text">Cell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Time-Stamp"><span class="toc-number">1.3.4.</span> <span class="toc-text">Time Stamp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Name-Space"><span class="toc-number">1.3.5.</span> <span class="toc-text">Name Space</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase原理"><span class="toc-number">2.</span> <span class="toc-text">HBase原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#写流程"><span class="toc-number">2.1.</span> <span class="toc-text">写流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MemStore-Flush"><span class="toc-number">2.2.</span> <span class="toc-text">MemStore Flush</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读流程"><span class="toc-number">2.3.</span> <span class="toc-text">读流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StoreFile-Compaction"><span class="toc-number">2.4.</span> <span class="toc-text">StoreFile Compaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读写扩展"><span class="toc-number">2.5.</span> <span class="toc-text">读写扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据真正删除的时间"><span class="toc-number">2.6.</span> <span class="toc-text">数据真正删除的时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Region-Split"><span class="toc-number">2.7.</span> <span class="toc-text">Region Split</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase-API-操作"><span class="toc-number">3.</span> <span class="toc-text">HBase API 操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DDL-DML"><span class="toc-number">3.1.</span> <span class="toc-text">DDL&#x2F;DML</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#与MapReduce交互"><span class="toc-number">4.</span> <span class="toc-text">与MapReduce交互</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境配置"><span class="toc-number">4.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#官方案例"><span class="toc-number">4.2.</span> <span class="toc-text">官方案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义-MR1"><span class="toc-number">4.3.</span> <span class="toc-text">自定义-MR1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义-MR2"><span class="toc-number">4.4.</span> <span class="toc-text">自定义-MR2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#与Hive集成"><span class="toc-number">5.</span> <span class="toc-text">与Hive集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase-与-Hive-的对比"><span class="toc-number">5.1.</span> <span class="toc-text">HBase 与 Hive 的对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境准备"><span class="toc-number">5.2.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例一"><span class="toc-number">5.3.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例二"><span class="toc-number">5.4.</span> <span class="toc-text">案例二</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase优化"><span class="toc-number">6.</span> <span class="toc-text">HBase优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#高可用"><span class="toc-number">6.1.</span> <span class="toc-text">高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预分区"><span class="toc-number">6.2.</span> <span class="toc-text">预分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RowKey设计"><span class="toc-number">6.3.</span> <span class="toc-text">RowKey设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存-amp-其他"><span class="toc-number">6.4.</span> <span class="toc-text">内存&amp;其他</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/default_p4.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">Hbase-进阶</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-09-17<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2019-11-28</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E5%BC%8F/">大数据分布式</a><i class="fa fa-angle-right fa-fw" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E5%BC%8F/Hadoop/">Hadoop</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">6.2k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 26 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/09/17/20190917204715525/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/09/17/20190917204715525/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><blockquote>
<p>参考：<a href="https://www.bilibili.com/video/av65548392" target="_blank" rel="noopener">https://www.bilibili.com/video/av65548392</a></p>
</blockquote>
<p>[TOC]</p>
<h1 id="Hbase数据模型"><a href="#Hbase数据模型" class="headerlink" title="Hbase数据模型"></a>Hbase数据模型</h1><h2 id="Hbase逻辑结构"><a href="#Hbase逻辑结构" class="headerlink" title="Hbase逻辑结构"></a>Hbase逻辑结构</h2><p>逻辑上，Hbase看起来像关系型数据库，存在一个表中。</p>
<p>但Hbase底层是k-v形式的，非关系型的。（列蔟）</p>
<h2 id="Hbase物理存储结构"><a href="#Hbase物理存储结构" class="headerlink" title="Hbase物理存储结构"></a>Hbase物理存储结构</h2><a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-18 下午11.01.06.png" data-fancybox="group" data-caption="屏幕快照 2019-09-18 下午11.01.06" class="fancybox"><img alt="屏幕快照 2019-09-18 下午11.01.06" style="zoom:50%;" title="屏幕快照 2019-09-18 下午11.01.06" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-18 下午11.01.06.png" class="lazyload"></a>



<p>一个Store是一个列蔟，不同的Store放在不同的文件夹里（类似Hive分区）。</p>
<p>memstore刷写一次，就形成一个文件StoreFile;</p>
<h2 id="HBase数据结构"><a href="#HBase数据结构" class="headerlink" title="HBase数据结构"></a>HBase数据结构</h2><h3 id="RowKey"><a href="#RowKey" class="headerlink" title="RowKey"></a>RowKey</h3><p>与 nosql 数据库们一样,RowKey 是用来检索记录的主键。访问 HBASE table 中的行，只 有三种方式: </p>
<p>1.通过单个 RowKey 访问</p>
<p>2.通过 RowKey 的 range(正则) </p>
<p>3.全表扫描</p>
<p>在 HBASE 内部，RowKey 保存为字节数组。存储时，数据按照 RowKey 的字典序(byte order)排序存储。设计RowKey 时，要充分排序存储这个特性，将经常一起读取的行存储放到一起。(位置相关性) </p>
<h3 id="Column-Family"><a href="#Column-Family" class="headerlink" title="Column Family"></a>Column Family</h3><p>列族是表的 schema 的一部 分(而列不是)，必须在使用表之前定义。</p>
<p>列名都以列族作为前缀。例如 courses:history，courses:math都属于 courses 这个列族。</p>
<h3 id="Cell"><a href="#Cell" class="headerlink" title="Cell"></a>Cell</h3><p>由{rowkey, column Family:columu, version} 唯一确定的单元。cell 中的数据是没有类型的，全部是字节码形式存储。</p>
<h3 id="Time-Stamp"><a href="#Time-Stamp" class="headerlink" title="Time Stamp"></a>Time Stamp</h3><p>版本通过时间戳来索引。</p>
<p>赋值：时间戳可以由 HBASE(在数据写入时自动 )赋值，此时时间戳是精确到毫秒 的当前系统时间。时间戳<br>也可以由客户显式赋值。</p>
<p>唯一性：如果应用程序要避免数据版 本冲突，就必须自己生成具有唯一性的时间戳。每个 cell 中，不同版本的数据按照时间倒序排序，即最新的数据排在最前面。</p>
<p>版本回收：为了避免数据存在过多版本造成的的管理 (包括存贮和索引)负担，HBASE 提供 了两<br>种数据版本回收方式。一是保存数据的最后 n 个版本，二是保存最近一段 时间内的版本(比<br>如最近七天)。用户可以针对每个列族进行设置。</p>
<h3 id="Name-Space"><a href="#Name-Space" class="headerlink" title="Name Space"></a>Name Space</h3><p>命名空间的结构:</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-17 下午8.59.23.png" data-fancybox="group" data-caption="屏幕快照 2019-09-17 下午8.59.23" class="fancybox"><img alt="屏幕快照 2019-09-17 下午8.59.23" style="zoom:50%;" title="屏幕快照 2019-09-17 下午8.59.23" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-17 下午8.59.23.png" class="lazyload"></a>

<p>1) Table:表，所有的表都是命名空间的成员，即表必属于某个命名空间，如果没有指定， 则在 default 默认的命名空间中。</p>
<p>2) RegionServer group:一个命名空间包含了默认的 RegionServer Group。</p>
<p>3) Permission:权限，命名空间能够让我们来定义访问控制列表 ACL(Access Control List)。 例如，创建表，读取表，删除，更新等等操作。 </p>
<p>4) Quota:限额，可以强制一个命名空间可包含的 region 的数量。 </p>
<h1 id="HBase原理"><a href="#HBase原理" class="headerlink" title="HBase原理"></a>HBase原理</h1><h2 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h2><p>Hbase读比写慢。</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-18 下午11.29.15.png" data-fancybox="group" data-caption="屏幕快照 2019-09-18 下午11.29.15" class="fancybox"><img alt="屏幕快照 2019-09-18 下午11.29.15" style="zoom:60%;" title="屏幕快照 2019-09-18 下午11.29.15" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-18 下午11.29.15.png" class="lazyload"></a>

<p>table表位置信息存在meta表里，所以先找meta表，通过meta表找table表的位置信息。</p>
<p>然后开始写入：</p>
<p>1)Client 向 HregionServer 发送写请求; </p>
<p>HBase 写数据流程 </p>
<p>2)HregionServer 将数据写到 HLog(write ahead log)。为了数据的持久化和恢复; 3)HregionServer 将数据写到内存(MemStore);<br> 4)反馈 Client 写成功。 </p>
<p>看一下如何从zk找到meta位置信息的</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br><span class="line">ls /hbase</span><br><span class="line">get /hbase/meta-region-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看出meta表在hadoop104里。接下来就是请求104去读meta表。</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scan <span class="string">"hbase:meta"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发现stu表由102维护的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后客户端去连接102，真正开始写数据（wal-mem）</span></span><br></pre></td></tr></table></figure></div>

<p>写数据流程：源码流程</p>
<p>…</p>
<h2 id="MemStore-Flush"><a href="#MemStore-Flush" class="headerlink" title="MemStore Flush"></a>MemStore Flush</h2><p>文件刷写，从内存到hdfs</p>
<p>刷写时机，可配置，hbase-default.xml</p>
<p>1)当 MemStore 数据达到阈值(默认是 128M，老版本是 64M)，将数据刷到硬盘，将内存<br>中的数据删除，同时删除 HLog 中的历史数据;<br>2)并将数据存储到 HDFS 中;<br>3)在 HLog 中做标记点。</p>
<h2 id="读流程"><a href="#读流程" class="headerlink" title="读流程"></a>读流程</h2><a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午3.58.01.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午3.58.01" class="fancybox"><img alt="屏幕快照 2019-09-19 下午3.58.01" style="zoom:50%;" title="屏幕快照 2019-09-19 下午3.58.01" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午3.58.01.png" class="lazyload"></a>



<p>一个理解误区：先读内存，内存有就直接返回，不读磁盘了。内存没有才读磁盘，然后写入BlockCache，再返回。</p>
<p>–这个理解是错的。</p>
<p>BlockCache：LRU，存储最近经常读的数据。</p>
<p>案例：在A时间点put/1001/info:name/张三，一个小时后，该数据就已经刷写到磁盘了。这时再put/1001/info:name/李四，但时间戳B是我自己传入的，且B&lt;A。</p>
<p>那我查数据的时候，合理情况下应该查到张三（时间最近的一条数据），但基于这个错误读的理解，返回的肯定是B(还在内存里)。</p>
<hr>
<p>那怎么才能正确返回A呢？</p>
<p>需要把内存和磁盘都读出来做比较。</p>
<p>写代码做实验：略</p>
<p>合理解释：不是先读内存，再读磁盘。而是BlockCache与MemStore一起读的。如果BlockCache有数据，就两个一起做wage合并，比较时间戳，返回时间戳大的那一个。如果BlockCache没数据，就去磁盘读，磁盘读到的数据，放入BlockCache里，再wage，返回时间戳大的。</p>
<p>base读比写慢。因为读也是要等磁盘时间的，而且步骤很多。</p>
<h2 id="StoreFile-Compaction"><a href="#StoreFile-Compaction" class="headerlink" title="StoreFile Compaction"></a>StoreFile Compaction</h2><p>问题引入：如果到了一定时间段，memStore存储还没有满上限，这个时候，也会刷数据到磁盘，每刷一次就是个新文件。所以在写频率小的情况下，会出现很多小文件。因此要做定期合并节约空间。</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.13.08.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.13.08" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.13.08" style="zoom:50%;" title="屏幕快照 2019-09-19 下午4.13.08" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.13.08.png" class="lazyload"></a>

<p>小合并会把多种时间戳版本都保留，大合并开始删除（覆盖）时间戳小的。</p>
<p>hbase-default.xml。默认7天自动触发大合并，官方建议在生产环境关掉（设置为0），应该在空间时间触发，因为很耗时。</p>
<h2 id="读写扩展"><a href="#读写扩展" class="headerlink" title="读写扩展"></a>读写扩展</h2><p>读写数据可以不要HMaster，但是创建表(元数据操作)必须要HMaster参与。但是客户端就算找master也是通过z k去找的，所以实际上客户端直接打交道的是zk不是Master，因为Master高可用可能会变地址。</p>
<p>所以写客户端代码时，完全不需要HMaster的地址，只需要一个zk地址。</p>
<p>但是没有HMaster工作也不能正常执行：假如region到达一定大小被切分了，切分出来也不会调度到其他节点了。因为切分就是新生成一个Region，需要Master去改元数据，还要master把元数据调度到其他节点。</p>
<p>一个机子，放一个region?</p>
<h2 id="数据真正删除的时间"><a href="#数据真正删除的时间" class="headerlink" title="数据真正删除的时间"></a>数据真正删除的时间</h2><p>大合并的时候会删数据；</p>
<p>flush会删数据；</p>
<p>flush测试：</p>
<p>put 2个版本的数据库后，scan默认只能看到一条，要加VERSIONS查所有数据。</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.32.32.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.32.32" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.32.32" style="zoom:40%;" title="屏幕快照 2019-09-19 下午4.32.32" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.32.32.png" class="lazyload"></a>

<p>flush 后，再查所有数据，就只剩下一条了。</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.34.19.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.34.19" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.34.19" style="zoom:40%;" title="屏幕快照 2019-09-19 下午4.34.19" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.34.19.png" class="lazyload"></a>

<p>这时，flush只是把最大的版本刷到磁盘了，其他的版本都删除了。</p>
<hr>
<p>有的时候，flush也删不了：就是flush刷下去一条数据，然后flush又刷下去另一条数据，这时，两条数据不在同一个文件里，所以flush管不了。</p>
<p>总结：flush只管在MemCache里面的合并工作，磁盘的事它管不了。磁盘的合并只有交给major Compaction做。</p>
<p>大合并：</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.41.42.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.41.42" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.41.42" style="zoom:50%;" title="屏幕快照 2019-09-19 下午4.41.42" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.41.42.png" class="lazyload"></a>



<p>delete后，会什么时候删除标记呢？</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.45.54-8882771.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.45.54" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.45.54" style="zoom:40%;" title="屏幕快照 2019-09-19 下午4.45.54" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.45.54-8882771.png" class="lazyload"></a>

<p>标记还在。</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.46.58.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.46.58" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.46.58" style="zoom:40%;" title="屏幕快照 2019-09-19 下午4.46.58" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.46.58.png" class="lazyload"></a>

<p>标记什么时候被删？</p>
<a href="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.48.13.png" data-fancybox="group" data-caption="屏幕快照 2019-09-19 下午4.48.13" class="fancybox"><img alt="屏幕快照 2019-09-19 下午4.48.13" style="zoom:40%;" title="屏幕快照 2019-09-19 下午4.48.13" data-src="/2019/09/17/20190917204715525/屏幕快照 2019-09-19 下午4.48.13.png" class="lazyload"></a>

<p>说明标记是在major compact时候删的，flush时候不删。为什么？因为flush能管到删除内存的数据，但此时磁盘文件里可能还有历史数据，所以delete要保留标记，再大合并的时候再删。</p>
<h2 id="Region-Split"><a href="#Region-Split" class="headerlink" title="Region Split"></a>Region Split</h2><p>数据合并越来越大，就得做切分。切分也有时机。</p>
<p>一个region最大file大小：10G，如果有列蔟超过这个大小，就切分。</p>
<p>当合并的数据超过时进行拆分，将拆分后的 Region 分配给不同的 HregionServer 管理;<br> 3)当 HregionServer 宕机后，将 HregionServer 上的 hlog 拆分，然后分配给不同的 HregionServer 加载，修改.META.; </p>
<p>4)注意:HLog 会同步到 HDFS。</p>
<p>在生产环境做预分区：建表的时候就规划好分区 （row key:  1-10000，10001-20000）。当数据到达指定大小就按用户自定义去切。</p>
<p>/stu/region1</p>
<p>/stu/region2</p>
<h1 id="HBase-API-操作"><a href="#HBase-API-操作" class="headerlink" title="HBase API 操作"></a>HBase API 操作</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">xml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--很少用，一般client就够了--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="DDL-DML"><a href="#DDL-DML" class="headerlink" title="DDL/DML"></a>DDL/DML</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DDL:</span></span><br><span class="line"><span class="comment"> * 1.判断表是否存在</span></span><br><span class="line"><span class="comment"> * 2.创建表</span></span><br><span class="line"><span class="comment"> * 3.创建命名空间</span></span><br><span class="line"><span class="comment"> * 4.删除表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DML</span></span><br><span class="line"><span class="comment"> * 5.插入数据</span></span><br><span class="line"><span class="comment"> * 6.查数据（get）</span></span><br><span class="line"><span class="comment"> * 7.查数据（scan）</span></span><br><span class="line"><span class="comment"> * 8.删除数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HDFS yarn zookeeper ==&gt; hbase</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAPI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Admin admin = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection connection = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Configuration configuration = HBaseConfiguration.create();</span><br><span class="line">            configuration.set(<span class="string">"hbase.zookeeper.quorum"</span>,<span class="string">"mxxcentos7"</span>);</span><br><span class="line"></span><br><span class="line">            connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">            admin = connection.getAdmin();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(admin!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(connection!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isTableExist</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> exists = admin.tableExists(TableName.valueOf(tableName));</span><br><span class="line">        <span class="keyword">return</span> exists;<span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTable</span><span class="params">(String tableName, String... columnFamilys)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(isTableExist(tableName))&#123;</span><br><span class="line">            log.error(tableName+<span class="string">"表已经存在！"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(columnFamilys.length &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            log.error(<span class="string">"请设置列蔟信息！"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HTableDescriptor hTableDescriptor = <span class="keyword">new</span> HTableDescriptor(TableName.valueOf(tableName));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String columnFamily : columnFamilys) &#123;</span><br><span class="line">            HColumnDescriptor hColumnDescriptor = <span class="keyword">new</span> HColumnDescriptor(columnFamily);</span><br><span class="line">            hTableDescriptor.addFamily(hColumnDescriptor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        admin.createTable(hTableDescriptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dropTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!isTableExist(tableName))&#123;</span><br><span class="line">            log.error(<span class="string">"&#123;&#125;表不存在！"</span>, tableName);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        admin.disableTable(TableName.valueOf(tableName));</span><br><span class="line">        admin.deleteTable(TableName.valueOf(tableName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createNameSpace</span><span class="params">(String nsName)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        NamespaceDescriptor namespaceDescriptor = NamespaceDescriptor.create(nsName).build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            admin.createNamespace(namespaceDescriptor);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamespaceExistException e)&#123;</span><br><span class="line">            log.warn(<span class="string">"&#123;&#125;命名空间已存在"</span>,nsName);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putData</span><span class="params">(String tableName, String rowKey, String cf, String cn, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line"></span><br><span class="line">        Put put = <span class="keyword">new</span> Put(Bytes.toBytes(rowKey));</span><br><span class="line">        put.addColumn(Bytes.toBytes(cf), Bytes.toBytes(cn), Bytes.toBytes(value));</span><br><span class="line"></span><br><span class="line">        table.put(put);</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getData</span><span class="params">(String tableName, String rowKey, String cf, String cn)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        Get get = <span class="keyword">new</span> Get(Bytes.toBytes(rowKey));</span><br><span class="line">        get.addColumn(Bytes.toBytes(cf), Bytes.toBytes(cn));</span><br><span class="line">        <span class="comment">// 获取多个版本数据</span></span><br><span class="line">        get.setMaxVersions(<span class="number">5</span>);</span><br><span class="line">        Result result = table.get(get);</span><br><span class="line">        Cell[] cells = result.rawCells();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Cell cell : cells) &#123;</span><br><span class="line">            String CF = Bytes.toString(CellUtil.cloneFamily(cell));</span><br><span class="line">            String CN = Bytes.toString(CellUtil.cloneQualifier(cell));</span><br><span class="line">            String Value = Bytes.toString(CellUtil.cloneValue(cell));</span><br><span class="line">            System.out.println(<span class="string">"CF: "</span> + CF + <span class="string">","</span> +</span><br><span class="line">                    <span class="string">"CN: "</span> + CN + <span class="string">","</span> +</span><br><span class="line">                    <span class="string">"Value: "</span> + Value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        <span class="comment">// 空参，扫描全表</span></span><br><span class="line">        Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">        ResultScanner resultScanner = table.getScanner(scan);</span><br><span class="line">        <span class="keyword">for</span> (Result result : resultScanner) &#123;</span><br><span class="line">            Cell[] cells = result.rawCells();</span><br><span class="line">            <span class="keyword">for</span> (Cell cell : cells) &#123;</span><br><span class="line">                String CF = Bytes.toString(CellUtil.cloneFamily(cell));</span><br><span class="line">                String CN = Bytes.toString(CellUtil.cloneQualifier(cell));</span><br><span class="line">                String Value = Bytes.toString(CellUtil.cloneValue(cell));</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"CF: "</span> + CF + <span class="string">","</span> +</span><br><span class="line">                        <span class="string">"CN: "</span> + CN + <span class="string">","</span> +</span><br><span class="line">                        <span class="string">"Value: "</span> + Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除列、列蔟、row key</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        删除总结：</span></span><br><span class="line"><span class="comment">        rowKey                  deleteFamily    所有版本</span></span><br><span class="line"><span class="comment">        rowKey+cf               deleteFamily    所有版本(传时间戳就是&lt;=t的全部删掉)</span></span><br><span class="line"><span class="comment">        rowKey+cf+cn+addColumns deleteColumn    所有版本(传时间戳就是&lt;=t的全部删掉)</span></span><br><span class="line"><span class="comment">        rowKey+cf+cn+addColumn  delete          删除单个版本(传时间戳就是只是删除该时间戳，不传就是删最新的) 慎用</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        建表的时候尽量用一个版本</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        delete也是一个put操作，put了一个删除标记</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteData</span><span class="params">(String tableName,String rowKey, String cf, String cn)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line"></span><br><span class="line">        Delete delete = <span class="keyword">new</span> Delete(Bytes.toBytes(rowKey));</span><br><span class="line"><span class="comment">//        delete.addFamily(Bytes.toBytes(cf));    // 删除列蔟</span></span><br><span class="line"><span class="comment">//        delete.addColumn(Bytes.toBytes(cf), Bytes.toBytes(cn));    // 删除单个版本，生产环境慎用</span></span><br><span class="line">        delete.addColumns(Bytes.toBytes(cf), Bytes.toBytes(cn));     <span class="comment">// 删除全部版本</span></span><br><span class="line">        table.delete(delete);</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1</span></span><br><span class="line"><span class="comment">//        System.out.println(isTableExist("stu"));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line"><span class="comment">//        createTable("stu2","info1","info2");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3</span></span><br><span class="line"><span class="comment">//        dropTable("stu2");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4</span></span><br><span class="line"><span class="comment">//        createNameSpace("mxx");</span></span><br><span class="line"><span class="comment">//        createTable("mxx:stu3","info1","info2");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5</span></span><br><span class="line"><span class="comment">//        putData("stu2","1001","info2","name","heihei");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6</span></span><br><span class="line"><span class="comment">//        getData("stu","1002","info","name");</span></span><br><span class="line"><span class="comment">//        System.out.println(isTableExist("stu2"));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量添加多个列 | 批量添加多个rowKey</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7</span></span><br><span class="line"><span class="comment">//        scanTable("stu");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8</span></span><br><span class="line">        deleteData(<span class="string">"stu2"</span>, <span class="string">"1001"</span>, <span class="string">"info1"</span>, <span class="string">"name"</span>);</span><br><span class="line">        close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h1 id="与MapReduce交互"><a href="#与MapReduce交互" class="headerlink" title="与MapReduce交互"></a>与MapReduce交互</h1><p>可以实现伴随 HBase 操作的 MapReduce 过程，比如使用MapReduce 将数据从本地文件系统导入到 HBase 的表中，比如从 HBase 中读取一些原始数据后使用 MapReduce 做数据分析。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~/.bash_profile</span><br><span class="line">export HBASE_HOME</span><br><span class="line">export HADOOP_HOME</span><br><span class="line"></span><br><span class="line">hadoop-env.sh 中配置:(注意:在 for 循环之后配)</span><br><span class="line">export HADOOP_CLASSPATH=$HADOOP_CLASSPATH:/home/machine/apps/hbase-1.2.0-cdh5.16.1/lib/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启</span></span><br><span class="line">stop-hbase.sh</span><br><span class="line">cd $HADOOP_HOME/sbin </span><br><span class="line">./stop-all.sh</span><br><span class="line">./start-dfs.sh</span><br><span class="line">./start-yarn.sh</span><br><span class="line">hadoop dfsadmin -safemode leave</span><br><span class="line">start-hbase.sh</span><br></pre></td></tr></table></figure></div>



<h2 id="官方案例"><a href="#官方案例" class="headerlink" title="官方案例"></a>官方案例</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd $HBASE_HOME</span><br><span class="line"><span class="meta">#</span><span class="bash"> 1、统计stu表的行数</span></span><br><span class="line">yarn jar lib/hbase-server-1.2.0-cdh5.16.1.jar rowcounter stu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印结果</span></span><br><span class="line">org.apache.hadoop.hbase.mapreduce.RowCounter$RowCounterMapper$Counters</span><br><span class="line">		ROWS=2</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、使用 MapReduce 将本地数据导入到 HBase</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建fruit.tsv 上传到hdfs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建表</span></span><br><span class="line">create "fruit","info"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入</span></span><br><span class="line">yarn jar lib/hbase-server-1.3.1.jar</span><br><span class="line">importtsv \</span><br><span class="line">-Dimporttsv.columns=HBASE_ROW_KEY,info:name,info:color fruit \ hdfs://mxxcentos7:9000/user/mxx/fruit/fruit.csv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看</span></span><br><span class="line">scan "fruit"</span><br></pre></td></tr></table></figure></div>



<h2 id="自定义-MR1"><a href="#自定义-MR1" class="headerlink" title="自定义-MR1"></a>自定义-MR1</h2><p>读取hdfs数据到hive表</p>
<p>demo:</p>
<p>FruitMapper</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>,<span class="title">LongWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        context.write(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>FruitReducer</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableReducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    TableReducer&lt;KEYIN, VALUEIN, KEYOUT&gt; extends Reducer&lt;KEYIN, VALUEIN, KEYOUT, Mutation&gt;</span></span><br><span class="line"><span class="comment">    Mutation: put delete increment append</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitReducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*    private String cf1;</span></span><br><span class="line"><span class="comment">    @Override</span></span><br><span class="line"><span class="comment">    protected void setup(Context context) throws IOException, InterruptedException &#123;</span></span><br><span class="line"><span class="comment">        Configuration configuration = context.getConfiguration();</span></span><br><span class="line"><span class="comment">        cf1 = configuration.get("cf1");</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(LongWritable key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Text value : values) &#123;</span><br><span class="line">            String[] fields = value.toString().split(<span class="string">"\t"</span>);</span><br><span class="line">            Put put = <span class="keyword">new</span> Put(Bytes.toBytes(fields[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">            put.addColumn(Bytes.toBytes(<span class="string">"info"</span>), Bytes.toBytes(<span class="string">"name"</span>), Bytes.toBytes(fields[<span class="number">1</span>]));</span><br><span class="line">            put.addColumn(Bytes.toBytes(<span class="string">"info"</span>), Bytes.toBytes(<span class="string">"color"</span>), Bytes.toBytes(fields[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">            context.write(NullWritable.get(), put);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>FruitDriver</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapReduceUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitDriver</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Job job = Job.getInstance(configuration);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(FruitDriver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(FruitMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        job.setMapOutputKeyClass(LongWritable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        job.setMapOutputValueClass(Text<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(args[<span class="number">1</span>], FruitReducer<span class="class">.<span class="keyword">class</span>, <span class="title">job</span>)</span>;</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">        configuration = conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">            <span class="keyword">int</span> run = ToolRunner.run(configuration, <span class="keyword">new</span> FruitDriver(), args);</span><br><span class="line">            System.exit(run);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>打包扔服务器</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn jar /media/psf/centos_share/note-hadoop-1.0-SNAPSHOT.jar mxx.hbaseDemo.mr1.FruitDriver /user/mxx/fruit/fruit.tsv fruit1</span><br><span class="line"></span><br><span class="line">scan "fruit1"</span><br></pre></td></tr></table></figure></div>



<h2 id="自定义-MR2"><a href="#自定义-MR2" class="headerlink" title="自定义-MR2"></a>自定义-MR2</h2><p>Hbase互相写数据。需求：将fruit1的name全部读到fruit2</p>
<p>Fruit2Mapper</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.Cell;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.CellUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Mapper</span> <span class="keyword">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(ImmutableBytesWritable key, Result value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Put put = <span class="keyword">new</span> Put(key.get());</span><br><span class="line">        <span class="keyword">for</span> (Cell cell : value.rawCells()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"name"</span>.equals(Bytes.toString(CellUtil.cloneQualifier(cell))))&#123;</span><br><span class="line">                put.add(cell);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.write(key, put);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>Fruit2Reducer</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableReducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Reducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Put put : values) &#123;</span><br><span class="line">            context.write(NullWritable.get(), put);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>Fruit2Driver</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mxx.hbaseDemo.mr2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Scan;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapReduceUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 本地连接到Hbase运行：指定HBase环境</span></span><br><span class="line"><span class="comment"> * cat conf/hbase-site.xml 复制到项目中</span></span><br><span class="line"><span class="comment"> * resources/hbase-site.xml</span></span><br><span class="line"><span class="comment"> * 并且删除hbase.tmp.dir配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 这种模式就是本地运行，没有使用Hadoop Yarn框架。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Driver</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Configuration configuration = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Job job = Job.getInstance(configuration);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(Fruit2Driver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        TableMapReduceUtil.initTableMapperJob(<span class="string">"fruit1"</span>,</span><br><span class="line">                <span class="keyword">new</span> Scan(),</span><br><span class="line">                Fruit2Mapper<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">ImmutableBytesWritable</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">Put</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">job</span></span></span><br><span class="line"><span class="class">        )</span>;</span><br><span class="line"></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(<span class="string">"fruit2"</span>,</span><br><span class="line">                Fruit2Reducer<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">job</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">        configuration = conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            Configuration configuration = new Configuration();</span></span><br><span class="line">            Configuration configuration = HBaseConfiguration.create();</span><br><span class="line">            configuration.addResource(<span class="string">"hbase-site.xml"</span>);</span><br><span class="line">            <span class="keyword">int</span> run = ToolRunner.run(configuration, <span class="keyword">new</span> Fruit2Driver(), args);</span><br><span class="line">            System.exit(run);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h1 id="与Hive集成"><a href="#与Hive集成" class="headerlink" title="与Hive集成"></a>与Hive集成</h1><h2 id="HBase-与-Hive-的对比"><a href="#HBase-与-Hive-的对比" class="headerlink" title="HBase 与 Hive 的对比"></a>HBase 与 Hive 的对比</h2><p>Hive</p>
<p>(1) 数据仓库<br>Hive 的本质其实就相当于将 HDFS 中已经存储的文件在 Mysql 中做了一个双射关系，以方便使用 HQL 去管理查询。</p>
<p>(2) 用于数据分析、清洗<br>Hive 适用于离线的数据分析和清洗，延迟较高。</p>
<p>(3) 基于 HDFS、MapReduce<br>Hive 存储的数据依旧在 DataNode 上，编写的 HQL 语句终将是转换为 MapReduce 代码执行。</p>
<p>HBase</p>
<p>(1) 数据库<br>是一种面向列存储的非关系型数据库。</p>
<p>(2) 用于存储结构化和非结构化的数据<br>适用于单表非关系型数据的存储，不适合做关联查询，类似 JOIN 等操作。</p>
<p>(3) 基于 HDFS<br>数据持久化存储的体现形式是 Hfile，存放于 DataNode 中，被 ResionServer 以 region 的形<br>式进行管理。</p>
<p>(4) 延迟较低，接入在线业务使用<br>面对大量的企业数据，HBase 可以直线单表大量数据的存储，同时提供了高效的数据访问<br>速度。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>Hive操作Hbase，类似于MapReduce操作Hbase。Hive需要持有Hbase的相关jar包。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_HOME=/opt/module/hbase </span><br><span class="line">export HIVE_HOME=/opt/module/hive</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 软连接</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-common-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-common-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-server-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-server-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-client-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-client-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-protocol-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-protocol-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-it-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-it-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/htrace-core-3.2.0-incubating.jar $HIVE_HOME/lib/htrace-core-3.2.0-incubating.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop2-compat-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-hadoop2-compat-1.2.0-cdh5.16.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop-compat-1.2.0-cdh5.16.1.jar $HIVE_HOME/lib/hbase-hadoop-compat-1.2.0-cdh5.16.1.jar</span><br></pre></td></tr></table></figure></div>

<p>在 hive-site.xml 中修改 zookeeper 的属性，如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">xml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>mxxcentos7<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.client.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><p>建立 Hive 表，关联 HBase 表，插入数据到 Hive 表的同时能够影响 HBase 表。</p>
<p>在 Hive 中创建表同时关联 HBase</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ./bin/hive</span></span><br><span class="line"><span class="comment">-- cdh避免了兼容问题，若遇到不兼容，需要自己编译对应的-src.jar源码包。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hive_hbase_emp_table( </span><br><span class="line">  empno <span class="built_in">int</span>,</span><br><span class="line">  ename <span class="keyword">string</span>,</span><br><span class="line">  job <span class="keyword">string</span>,</span><br><span class="line">  mgr <span class="built_in">int</span>,</span><br><span class="line">  hiredate <span class="keyword">string</span>,</span><br><span class="line">  sal <span class="keyword">double</span>,</span><br><span class="line">  comm <span class="keyword">double</span>,</span><br><span class="line">  deptno <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">"hbase.columns.mapping"</span> = <span class="string">":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:co mm,info:deptno"</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">"hbase.table.name"</span> = <span class="string">"hbase_emp_table"</span>);</span><br></pre></td></tr></table></figure></div>

<p>完成之后，可以分别进入 Hive 和 HBase 查看，都生成了对应的表</p>
<p>接下来是导数据（数据是放在Hbase里的，不能直接用load语句，load是放在hdfs txt文件里的）</p>
<p>1、在 Hive 中创建临时中间表，用于 load 文件中的数据</p>
<p>2、Hive 中间表中 load 数据</p>
<p>3、通过 insert 命令将中间表中的数据导入到 Hive 关联 HBase 的那张表中</p>
<p>4、查看 Hive 以及关联的 HBase 表中是否已经成功的同步插入了数据</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建临时中间表</span></span><br><span class="line">CREATE TABLE emp(</span><br><span class="line">  empno int,</span><br><span class="line">  ename string,</span><br><span class="line">  job string,</span><br><span class="line">  mgr int,</span><br><span class="line">  hiredate string,</span><br><span class="line">  sal double,</span><br><span class="line">  comm double,</span><br><span class="line">  deptno int)</span><br><span class="line">row format delimited fields terminated by '\t';</span><br><span class="line"><span class="meta">#</span><span class="bash"> load数据到中间表</span></span><br><span class="line"><span class="meta">hive&gt;</span><span class="bash"> load data <span class="built_in">local</span> inpath <span class="string">'/media/psf/centos_share/emp.txt'</span> into table emp;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> insert将中间表数据导入到 Hive 关联 HBase 的那张表中</span></span><br><span class="line"><span class="meta">hive&gt;</span><span class="bash"> insert into table hive_hbase_emp_table select * from emp;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 Hive 以及关联的 HBase 表中是否已经成功的同步插入了数据</span></span><br><span class="line"><span class="meta">hive&gt;</span><span class="bash"> select * from hive_hbase_emp_table;</span></span><br><span class="line"><span class="meta">hbase&gt;</span><span class="bash"> scan ‘hbase_emp_table’</span></span><br><span class="line"></span><br><span class="line">如果mr任务卡了，尝试：</span><br><span class="line">mapreduce测试：</span><br><span class="line">1、yarn jar $HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.6.0-cdh5.16.1.jar wordcount /test/test.txt /test/out6</span><br><span class="line">2、给虚拟机分配更大的内存</span><br></pre></td></tr></table></figure></div>



<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><p>在 HBase 中已经存储了某一张表 hbase_emp_table，然后在 Hive 中创建一个外部表来关联 HBase 中的 hbase_emp_table 这张表，使之可以借助 Hive 来分析 HBase 这张表中的数据。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> hive</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建外部表关联已经存在的hbase表</span></span><br><span class="line">CREATE EXTERNAL TABLE relevance_hbase_emp( </span><br><span class="line">  empno int,</span><br><span class="line">  ename string,</span><br><span class="line">  job string,</span><br><span class="line">  mgr int,</span><br><span class="line">  hiredate string,</span><br><span class="line">  sal double,</span><br><span class="line">  comm double,</span><br><span class="line">  deptno int)</span><br><span class="line">STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span><br><span class="line">WITH SERDEPROPERTIES ("hbase.columns.mapping" = ":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:co mm,info:deptno")</span><br><span class="line">TBLPROPERTIES ("hbase.table.name" = "hbase_emp_table");</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关联后就可以使用 Hive 函数进行一些分析操作了</span></span><br><span class="line">hive &gt; select * from relevance_hbase_emp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从hbase put 数据，hive能同步到吗？ 能</span></span><br><span class="line">hive &gt; put 'hbase_emp_table','7935','info:ename','zhangsan'</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> hbase</span></span><br><span class="line">7935	zhangsan	NULL	NULL	NULL	NULL	NULL	NULL</span><br></pre></td></tr></table></figure></div>



<h1 id="HBase优化"><a href="#HBase优化" class="headerlink" title="HBase优化"></a>HBase优化</h1><h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>在 HBase 中 Hmaster 负责监控 RegionServer 的生命周期，均衡 RegionServer 的负载，如果 Hmaster 挂掉了，那么整个 HBase 集群将陷入不健康的状态，并且此时的工作状态并不会维持太久。所以 HBase 支持对 Hmaster 的高可用配置。</p>
<p>高可用配置节点配置（备用Master）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动2个backup Master, 主 master挂了之后，就会自动上backup Master</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 conf 目录下创建 backup-masters 文件 </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> touch conf/backup-masters</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 backup-masters 文件中配置高可用 HMaster 节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> hadoop103 &gt; conf/backup-masters</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将整个 conf 目录 scp 到其他节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> scp -r conf/ hadoop103:/opt/module/hbase/</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开页面测试查看</span></span><br><span class="line">http://hadooo102:16010</span><br></pre></td></tr></table></figure></div>



<h2 id="预分区"><a href="#预分区" class="headerlink" title="预分区"></a>预分区</h2><p>每一个 region 维护着 startRow 与 endRowKey，如果加入的数据符合某个 region 维护的rowKey 范围，则该数据交给这个 region 维护。那么依照这个原则，我们可以将数据所要投放的分区提前大致的规划好，以提高 HBase 性能。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、手动设定预分区 2.生成 16 进制序列预分区</span></span><br><span class="line"><span class="meta">hbase&gt;</span><span class="bash"> create <span class="string">'staff1'</span>,<span class="string">'info'</span>,<span class="string">'partition1'</span>,SPLITS =&gt; [<span class="string">'1000'</span>,<span class="string">'2000'</span>,<span class="string">'3000'</span>,<span class="string">'4000'</span>]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：400会落在第4个分区，而4000会落在第5分区</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、生成 16 进制序列预分区</span></span><br><span class="line">hbase &gt; create 'staff2','info','partition2',&#123;NUMREGIONS =&gt; 15, SPLITALGO =&gt; 'HexStringSplit'&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.按照文件中设置的规则预分区 创建 splits.txt 文件内容如下:</span></span><br><span class="line">splits.txt：</span><br><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内部按字母排序？</span></span><br><span class="line">hbase &gt; create 'staff3','partition3',SPLITS_FILE =&gt; 'splits.txt'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.使用 JavaAPI 创建预分区</span></span><br><span class="line">//自定义算法，产生一系列 Hash 散列值存储在二维数组中 </span><br><span class="line">byte[][] splitKeys = 某个散列值函数</span><br><span class="line">//创建 HBaseAdmin 实例</span><br><span class="line">HBaseAdmin hAdmin = new HBaseAdmin(HBaseConfiguration.create()); </span><br><span class="line">//创建 HTableDescriptor 实例</span><br><span class="line">HTableDescriptor tableDesc = new HTableDescriptor(tableName);</span><br><span class="line">//通过 HTableDescriptor 实例和散列值二维数组创建带有预分区的 HBase 表 </span><br><span class="line">hAdmin.createTable(tableDesc, splitKeys);</span><br></pre></td></tr></table></figure></div>

<p>分区规划和什么有关？</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">未来数据量、机器规模</span><br><span class="line">每台机器放2-3个region</span><br></pre></td></tr></table></figure></div>



<h2 id="RowKey设计"><a href="#RowKey设计" class="headerlink" title="RowKey设计"></a>RowKey设计</h2><p>一条数据的唯一标识就是 rowkey，那么这条数据存储于哪个分区，取决于 rowkey 处于哪个一个预分区的区间内，设计rowkey的主要目的 ，就是让数据<strong>均匀的分布</strong>于所有的region中，在一定程度上防止数据倾斜。接下来我们就谈一谈 rowkey 常用的设计方案。</p>
<p>1.生成随机数、hash、散列值</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">比如:</span><br><span class="line">原 本 rowKey 为 1001 的 ， SHA1 dd01903921ea24941c26a48f2cec24e0bb0e8cc7</span><br><span class="line">原 本 rowKey 为 3001 的 ， SHA1 49042c54de64a1e9bf0b33e00245660ef92dc7bd</span><br><span class="line">原 本 rowKey 为 5001 的 ， SHA1 7b61dec07e02c188790670af43e717f0f46e8913 </span><br><span class="line">在做此操作之前，一般我们会选择从数据集中抽取样本，来决定什么样的 rowKey 来 Hash 后作为每个分区的临界值。</span><br></pre></td></tr></table></figure></div>

<p>2.字符串反转</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">20170524000001 转成 10000042507102</span><br><span class="line">20170524000002 转成 20000042507102</span><br><span class="line">这样也可以在一定程度上散列逐步 put 进来的数据</span><br></pre></td></tr></table></figure></div>

<p>3.字符串拼接</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">20170524000001_a12e</span><br><span class="line">20170524000001_93i7</span><br></pre></td></tr></table></figure></div>



<p><strong>rowkey情景设计</strong></p>
<p>考虑散列性和集中性    </p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">分300个区</span><br><span class="line">000</span><br><span class="line">001</span><br><span class="line">002</span><br><span class="line">...</span><br><span class="line">298</span><br><span class="line"></span><br><span class="line">rowkey设计：</span><br><span class="line">000_</span><br><span class="line">001_</span><br><span class="line">002_</span><br><span class="line">...</span><br><span class="line">298_</span><br><span class="line"></span><br><span class="line">比如要拿一个人的通话详情，最好把手机号相同的放在一个分区，便于查找。</span><br><span class="line"></span><br><span class="line">如何将如手机号转换为rowkey？</span><br><span class="line">同一个手机号要得到同一个前缀</span><br><span class="line">策略：	手机号%299 &#x3D; 分区号</span><br><span class="line">分区号_xxx，后面跟手机号，便于连续读</span><br><span class="line">001_13199999999_xxx</span><br><span class="line"></span><br><span class="line">如何把一个人的通话记录按时间放在不同分区里？</span><br><span class="line">按年_月分区</span><br><span class="line">[(13199999999+201909).hash] % 299 &#x3D; 分区号</span><br><span class="line">001_13199999999_20191212 12:12:12</span><br><span class="line">这样，同一个人，同一个月肯定在同一个分区，而且数据集中在一块</span><br><span class="line"></span><br><span class="line">如何读取某个人2019-12的通话记录？</span><br><span class="line">start &#x3D; 001_13199999999_2019-12</span><br><span class="line">end &#x3D; 001_13199999999_2019-13</span><br></pre></td></tr></table></figure></div>



<h2 id="内存-amp-其他"><a href="#内存-amp-其他" class="headerlink" title="内存&amp;其他"></a>内存&amp;其他</h2><pre><code>HBase 操作过程中需要大量的内存开销，毕竟 Table 是可以缓存在内存中的，一般会分配整个可用内存的 70%给 HBase 的 Java 堆。但是不建议分配非常大的堆内存，因为 GC 过程持续太久会导致 RegionServer 处于长期不可用状态，一般 16~48G 内存就可以了，如果因为框架占用内存过高导致系统内存不足，框架一样会被系统服务拖死。</code></pre><hr>
<p><strong>基础优化</strong></p>
<p>略</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Machine</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://machine4869.gitee.io/2019/09/17/20190917204715525/">https://machine4869.gitee.io/2019/09/17/20190917204715525/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://machine4869.gitee.io">哑舍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据    </a></div><div class="post_share"><div class="social-share" data-image="/img/default_p4.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/10/08/20191008134811972/"><img class="prev_cover lazyload" data-src="/img/default_p8.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Hbase-案例</span></div></a></div><div class="next-post pull_right"><a href="/2019/09/16/20190916095939630/"><img class="next_cover lazyload" data-src="/img/default_p10.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Hbase-入门</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/12/26/20191226144408846/" title="ELK-搜索引擎"><img class="relatedPosts_cover lazyload"data-src="/img/default_p1.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-26</div><div class="relatedPosts_title">ELK-搜索引擎</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/11/20191211154140441/" title="数据仓库-业务数据仓库"><img class="relatedPosts_cover lazyload"data-src="/img/default_p10.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-11</div><div class="relatedPosts_title">数据仓库-业务数据仓库</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/04/20191204140743901/" title="数据仓库-用户行为数据仓库"><img class="relatedPosts_cover lazyload"data-src="/img/default_p4.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-04</div><div class="relatedPosts_title">数据仓库-用户行为数据仓库</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/21/20191121155413741/" title="数据仓库-用户行为数据采集"><img class="relatedPosts_cover lazyload"data-src="/img/default_p1.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-21</div><div class="relatedPosts_title">数据仓库-用户行为数据采集</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/21/20191121140654751/" title="Ambari-Hadoop Web UI"><img class="relatedPosts_cover lazyload"data-src="/img/default_p7.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-21</div><div class="relatedPosts_title">Ambari-Hadoop Web UI</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/19/20191119151208934/" title="Kettle-ETL工具&数据抽取"><img class="relatedPosts_cover lazyload"data-src="/img/default_p5.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-19</div><div class="relatedPosts_title">Kettle-ETL工具&数据抽取</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = true == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yPVvDIaWlODDhs0bbECwLIIp-gzGzoHsz',
  appKey:'VyOIa40LxnjURzW1HUCiwTpV',
  placeholder:'记得留下你的昵称及邮箱，以便收到答复~',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Machine</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://machine4869.gitee.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="canvas_nest" color="215,215,215" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>