<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>并发编程与线程安全（2）：并发编程&amp;线程安全 | 哑舍</title><meta name="description" content="并发编程与线程安全（2）：并发编程&amp;线程安全"><meta name="keywords" content="Java并发编程与高并发解决方案"><meta name="author" content="Machine"><meta name="copyright" content="Machine"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/cat2.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="并发编程与线程安全（2）：并发编程&amp;线程安全"><meta name="twitter:description" content="并发编程与线程安全（2）：并发编程&amp;线程安全"><meta name="twitter:image" content="https://machine4869.gitee.io/img/default_p9.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="并发编程与线程安全（2）：并发编程&amp;线程安全"><meta property="og:url" content="https://machine4869.gitee.io/2018/07/28/15327607157902/"><meta property="og:site_name" content="哑舍"><meta property="og:description" content="并发编程与线程安全（2）：并发编程&amp;线程安全"><meta property="og:image" content="https://machine4869.gitee.io/img/default_p9.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://machine4869.gitee.io/2018/07/28/15327607157902/"><link rel="prev" title="ES6新特征（基本+常用）" href="https://machine4869.gitee.io/2018/08/09/15338173277136/"><link rel="next" title="使用git将初始化代码托管到-项目初始化" href="https://machine4869.gitee.io/2018/07/28/15327623035290/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://machine4869.gitee.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">哑舍</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 豆瓣电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> 照片墙</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">134</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">27</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">45</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 豆瓣电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> 照片墙</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#第3章-项目准备"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">第3章 项目准备</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-1-案例环境初始化"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">3-1 案例环境初始化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-2-案例准备工作"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">3-2 案例准备工作</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-3-并发模拟-工具"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">3-3 并发模拟-工具</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-4-并发模拟-代码"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">3-4 并发模拟-代码</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#第4章-线程安全性"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">第4章 线程安全性</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-1-原子性-atomic"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">4-1 原子性-atomic</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-2-原子性-synchronized"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">4-2 原子性-synchronized</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-3-可见性"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">4-3 可见性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-4-有序性"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">4-4 有序性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-5-总结"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">4-5 总结</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第3章-项目准备"><span class="toc-number">1.</span> <span class="toc-text">第3章 项目准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-案例环境初始化"><span class="toc-number">1.1.</span> <span class="toc-text">3-1 案例环境初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-案例准备工作"><span class="toc-number">1.2.</span> <span class="toc-text">3-2 案例准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-并发模拟-工具"><span class="toc-number">1.3.</span> <span class="toc-text">3-3 并发模拟-工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-并发模拟-代码"><span class="toc-number">1.4.</span> <span class="toc-text">3-4 并发模拟-代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第4章-线程安全性"><span class="toc-number">2.</span> <span class="toc-text">第4章 线程安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-原子性-atomic"><span class="toc-number">2.1.</span> <span class="toc-text">4-1 原子性-atomic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-原子性-synchronized"><span class="toc-number">2.2.</span> <span class="toc-text">4-2 原子性-synchronized</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-可见性"><span class="toc-number">2.3.</span> <span class="toc-text">4-3 可见性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-有序性"><span class="toc-number">2.4.</span> <span class="toc-text">4-4 有序性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-总结"><span class="toc-number">2.5.</span> <span class="toc-text">4-5 总结</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/default_p9.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">并发编程与线程安全（2）：并发编程&amp;线程安全</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2018-07-28<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-02-15</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">Java并发编程与高并发解决方案</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">4.4k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 17 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2018/07/28/15327607157902/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2018/07/28/15327607157902/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>[TOC]</p>
<h1 id="第3章-项目准备"><a href="#第3章-项目准备" class="headerlink" title="第3章 项目准备"></a>第3章 项目准备</h1><h2 id="3-1-案例环境初始化"><a href="#3-1-案例环境初始化" class="headerlink" title="3-1 案例环境初始化"></a>3-1 案例环境初始化</h2><p><code>之前演示了线程不安全case,接下来处理这个问题</code></p>
<p>环境搭建与准备：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- Spring Boot</span><br><span class="line">- Git管理代码</span><br><span class="line">- Github</span><br><span class="line">- 使用git将初始化代码托管到[码云]（教程参考：我的[使用git将初始化代码托管到[码云]（项目初始化）](mweblib:&#x2F;&#x2F;15327623035290)）</span><br></pre></td></tr></table></figure></div>
<p>Packaging为war包</p>
<h2 id="3-2-案例准备工作"><a href="#3-2-案例准备工作" class="headerlink" title="3-2 案例准备工作"></a>3-2 案例准备工作</h2><p><strong>一些注解的准备</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 对于线程安全的类，加入一个@ThreadSafe注解的标示</span><br><span class="line"> * @Target(ElementType.TYPE) 说明作用于类上</span><br><span class="line"> * @Retention(RetentionPolicy.SOURCE) 指定注解作用的范围，在编译的时候就会被忽略掉</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.SOURCE)</span><br><span class="line">public @interface ThreadSafe &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 用来标示[线程不安全的类]</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.SOURCE)</span><br><span class="line">public @interface NotThreadSafe &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 用来标记[推荐]的类或者写法</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.SOURCE)</span><br><span class="line">public @interface Recommend &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 用来标记[不推荐]的类或者写法</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.SOURCE)</span><br><span class="line">public @interface NotRecommend &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>提交代码</p>
<h2 id="3-3-并发模拟-工具"><a href="#3-3-并发模拟-工具" class="headerlink" title="3-3 并发模拟-工具"></a>3-3 并发模拟-工具</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Postman:Http请求模拟工具</span><br><span class="line">Apache Bench(AB):Apache的工具，测试网站性能</span><br><span class="line">JMeter:Apache开发的压力测试工具</span><br><span class="line">代码：Semaphone、CountDownLatch等</span><br></pre></td></tr></table></figure></div>

<hr>
<p><strong>Postman</strong></p>
<p>技巧1:设置环境<br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.19.39.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.19.39" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.19.39" title="屏幕快照 2018-07-30 下午2.19.39" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.19.39.png" class="lazyload"></a></p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.19.55.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.19.55" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.19.55" title="屏幕快照 2018-07-30 下午2.19.55" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.19.55.png" class="lazyload"></a></p>
<p>使用<br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.21.39.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.21.39" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.21.39" title="屏幕快照 2018-07-30 下午2.21.39" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.21.39.png" class="lazyload"></a></p>
<p>技巧2:模拟并发<br>新增Collection<br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.24.49.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.24.49" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.24.49" title="屏幕快照 2018-07-30 下午2.24.49" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.24.49.png" class="lazyload"></a></p>
<hr>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.25.34.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.25.34" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.25.34" title="屏幕快照 2018-07-30 下午2.25.34" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.25.34.png" class="lazyload"></a></p>
<hr>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.28.01.png" data-fancybox="group" data-caption="屏幕快照 2018-07-30 下午2.28.01" class="fancybox"><img alt="屏幕快照 2018-07-30 下午2.28.01" title="屏幕快照 2018-07-30 下午2.28.01" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.28.01.png" class="lazyload"></a></p>
<hr>
<p><strong>Apache Bench</strong></p>
<p>下载安装：Mac命令行自带<br>参考：<a href="https://www.cnblogs.com/Ryana/p/6279232.html" target="_blank" rel="noopener">https://www.cnblogs.com/Ryana/p/6279232.html</a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 1000 -c 50 http:&#x2F;&#x2F;localhost:8080&#x2F;test</span><br></pre></td></tr></table></figure></div>
<p>请求数为1000 并发数为50</p>
<hr>
<p><strong>JMeter</strong></p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.00.58.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.00.58" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.00.58" title="屏幕快照 2018-08-04 下午2.00.58" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.00.58.png" class="lazyload"></a><br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.54.51.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.54.51" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.54.51" title="屏幕快照 2018-08-04 下午2.54.51" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.54.51.png" class="lazyload"></a></p>
<p>说明：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">线程数：虚拟用户的数量</span><br><span class="line">循环次数：每个用户请求多少次</span><br></pre></td></tr></table></figure></div>

<p>添加请求：</p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.55.13.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.55.13" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.55.13" title="屏幕快照 2018-08-04 下午2.55.13" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.55.13.png" class="lazyload"></a><br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.56.49.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.56.49" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.56.49" title="屏幕快照 2018-08-04 下午2.56.49" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.56.49.png" class="lazyload"></a></p>
<p>添加监听：</p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.56.13.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.56.13" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.56.13" title="屏幕快照 2018-08-04 下午2.56.13" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.56.13.png" class="lazyload"></a></p>
<p>添加日志：</p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.57.07.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.57.07" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.57.07" title="屏幕快照 2018-08-04 下午2.57.07" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.57.07.png" class="lazyload"></a></p>
<p>运行：</p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.57.23.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午2.57.23" class="fancybox"><img alt="屏幕快照 2018-08-04 下午2.57.23" title="屏幕快照 2018-08-04 下午2.57.23" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%882.57.23.png" class="lazyload"></a></p>
<h2 id="3-4-并发模拟-代码"><a href="#3-4-并发模拟-代码" class="headerlink" title="3-4 并发模拟-代码"></a>3-4 并发模拟-代码</h2><p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%883.08.27.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午3.08.27" class="fancybox"><img alt="屏幕快照 2018-08-04 下午3.08.27" title="屏幕快照 2018-08-04 下午3.08.27" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%883.08.27.png" class="lazyload"></a><br><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%883.08.36.png" data-fancybox="group" data-caption="屏幕快照 2018-08-04 下午3.08.36" class="fancybox"><img alt="屏幕快照 2018-08-04 下午3.08.36" title="屏幕快照 2018-08-04 下午3.08.36" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-04%20%E4%B8%8B%E5%8D%883.08.36.png" class="lazyload"></a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package com.machine.concurrency.test;</span><br><span class="line"></span><br><span class="line">import com.machine.concurrency.annotations.NotThreadSafe;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 并发测试：最大并发数为50次，每个线程（共5000个）都进行一次count++操作</span><br><span class="line"> * 测试结果：并发操作count++时，不做上锁处理，线程不安全，count最终达不到5000</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Slf4j</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class ConcurrencyTest &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;** 请求总数 *&#x2F;</span><br><span class="line">    public static int clientTotal &#x3D; 5000;</span><br><span class="line">    &#x2F;** 同时并发执行的线程数 *&#x2F;</span><br><span class="line">    public static int threadTotal &#x3D; 50;</span><br><span class="line"></span><br><span class="line">    public static int count &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        &#x2F;&#x2F; 创建线程池</span><br><span class="line">        ExecutorService executorService &#x3D; new ThreadPoolExecutor(0, Integer.MAX_VALUE,</span><br><span class="line">                60L, TimeUnit.SECONDS,</span><br><span class="line">                new SynchronousQueue&lt;&gt;(), r -&gt; new Thread(r,&quot;测试线程&quot;));</span><br><span class="line">        &#x2F;&#x2F; 信号量，闭锁 （允许同时50个并发）</span><br><span class="line">        final Semaphore semaphore &#x3D; new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch &#x3D; new CountDownLatch(clientTotal);</span><br><span class="line">        &#x2F;&#x2F; 模拟并发请求</span><br><span class="line">        for (int i &#x3D; 0; i &lt; clientTotal; i++) &#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 请求一个信号，如果信号量小于clientTotal，则阻塞</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    &#x2F;&#x2F; 释放一个信号</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 阻塞直到countDown 的次数为threadTotal (主线程要等5000个线程执行完毕才能继续执行)</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        &#x2F;&#x2F; 关闭线程池</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;,count);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 本质上应该是这个方法线程不安全</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static void add()&#123;</span><br><span class="line">        &#x2F;&#x2F;同时50个并发 进行count++操作，没有上锁，线程不安全</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">    CountDownLatch典型用法1：某一线程在开始运行前等待n个线程执行完毕。</span><br><span class="line">        将CountDownLatch的计数器初始化为n new CountDownLatch(n) ，</span><br><span class="line">        每当一个任务线程执行完毕，就将计数器减1 countdownlatch.countDown()，</span><br><span class="line">        当计数器的值变为0时，在CountDownLatch上 await() 的线程就会被唤醒。</span><br><span class="line">        一个典型应用场景就是启动一个服务时，主线程需要等待多个组件加载完毕，之后再继续执行。</span><br><span class="line"></span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure></div>

<h1 id="第4章-线程安全性"><a href="#第4章-线程安全性" class="headerlink" title="第4章 线程安全性"></a>第4章 线程安全性</h1><p><strong>线程安全性定义</strong></p>
<p>当多个线程访问某个类时，不管运行时环境采用<strong>何种调度方式</strong>或者这些进程将如何交替执行，并且在主调代码中<strong>不需要额外的同步或协同</strong>，这个类都能表现出正确行为，那么就称这个类是线程安全的</p>
<p><strong>三个方面</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原子性：提供了互斥访问，同一时刻只能有一个线程来对它进行操作</span><br><span class="line"></span><br><span class="line">可见性：一个线程对主内存的修改可以及时的被其他线程观察到</span><br><span class="line"></span><br><span class="line">有序性：一个线程观察其它线程的指令执行顺序，由于重排序的存在，该观察结果一般杂乱无序</span><br></pre></td></tr></table></figure></div>

<h2 id="4-1-原子性-atomic"><a href="#4-1-原子性-atomic" class="headerlink" title="4-1 原子性-atomic"></a>4-1 原子性-atomic</h2><p><strong>原子性-Atomic包</strong></p>
<p><a href="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-09-05%20%E4%B8%8B%E5%8D%885.08.40.png" data-fancybox="group" data-caption="屏幕快照 2018-09-05 下午5.08.40" class="fancybox"><img alt="屏幕快照 2018-09-05 下午5.08.40" title="屏幕快照 2018-09-05 下午5.08.40" data-src="/2018/07/28/15327607157902/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-09-05%20%E4%B8%8B%E5%8D%885.08.40.png" class="lazyload"></a></p>
<p>改进3-4的代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.machine.concurrency.example.count;</span><br><span class="line">import com.machine.concurrency.annotations.ThreadSafe;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class CountExample2 &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 请求总数</span><br><span class="line">    public static int clientTotal &#x3D; 5000;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal &#x3D; 200;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;互斥计数：每次只允许一个进行访问，保证了线程安全</span><br><span class="line">    public static AtomicInteger count &#x3D; new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService &#x3D; Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore &#x3D; new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch &#x3D; new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void add() &#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">        &#x2F;&#x2F; count.getAndIncrement();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>1.AtomicXXX:CAS 、Unsafe.compareAndSwapInt</strong></p>
<p>看一下AtomicInteger.getAndIncrement的源码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Atomically increments by one the current value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 主要是调用了unsafe的方法 </span></span><br><span class="line">     <span class="comment">//     private static final Unsafe unsafe = Unsafe.getUnsafe();</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  获取底层当前的值并且+1</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var1 需要操作的AtomicInteger 对象</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var2 当前的值 </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var4 要增加的值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> var5;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 获取底层的该对象当前的值</span></span><br><span class="line">            var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">            <span class="comment">// 获取完底层的值和自增操作之间，可能系统的值已经又被其他线程改变了</span></span><br><span class="line">            <span class="comment">//如果又被改变了，则重新计算系统底层的值，并重新执行本地方法</span></span><br><span class="line">        &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4)); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var5;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 本地的CAS方法核心</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var1 需要操作的AtomicInteger 对象</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var2 当前本地变量中的的值 </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var4 当前系统从底层传来的值</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> var5 要更新后的值</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Return</span> 如果当前本地变量的值（var2）与底层的值(var4)不等，则返回false，否则更新为var5的值并返回True</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4, <span class="keyword">int</span> var5)</span></span>;</span><br></pre></td></tr></table></figure></div>

<p><strong>2.AtomicLong、LongAdder</strong></p>
<p>我们看到AtomicInteger在执行CAS操作的时候，是用死循环的方式，如果竞争非常激烈，那么失败量就会很高，性能会受到影响</p>
<p>再看一下1.8以后的LongAdder</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void add(long x) &#123;</span><br><span class="line">        Cell[] as; long b, v; int m; Cell a;</span><br><span class="line">        if ((as &#x3D; cells) !&#x3D; null || !casBase(b &#x3D; base, b + x)) &#123;</span><br><span class="line">            boolean uncontended &#x3D; true;</span><br><span class="line">            if (as &#x3D;&#x3D; null || (m &#x3D; as.length - 1) &lt; 0 ||</span><br><span class="line">                (a &#x3D; as[getProbe() &amp; m]) &#x3D;&#x3D; null ||</span><br><span class="line">                !(uncontended &#x3D; a.cas(v &#x3D; a.value, v + x)))</span><br><span class="line">                longAccumulate(x, null, uncontended);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>补充知识点，jvm对long，double这些64位的变量拆成两个32位的操作</p>
<p>LongAdder的设计思想：核心是将热点数据分离，将内部数据value分成一个数组，每个线程访问时，通过hash等算法映射到其中一个数字进行技术，而最终计数结果为这个数组的求和累加，<br>其中热点数据value会被分离成多个热点单元的数据cell，每个cell独自维护内部的值，当前value的实际值由所有的cell累积合成，从而使热点进行了有效的分离，提高了并行度<br>LongAdder 在低并发的时候通过直接操作base，可以很好的保证和Atomic的性能基本一致，在高并发的场景，通过热点分区来提高并行度<br>缺点：在统计的时候如果有并发更新，可能会导致结果有些误差</p>
<p><strong>3.AtomicReference、AtomicReferenceFieldUpdater</strong></p>
<p>AtomicReference: 用法同AtomicInteger一样，但是可以放各种对象</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicReference&lt;Integer&gt; count = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//public final boolean compareAndSet(V expect, V update)</span></span><br><span class="line">    <span class="comment">// 如果当前值=expect期待值，就将当前值更新为update，并且返回true</span></span><br><span class="line">    <span class="comment">// 否则，就不更新，并且返回</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 2/true</span></span><br><span class="line">        System.out.println(count.compareAndSet(<span class="number">0</span>,<span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 2/false</span></span><br><span class="line">        System.out.println(count.compareAndSet(<span class="number">0</span>,<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 2/false</span></span><br><span class="line">        count.compareAndSet(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 4/true</span></span><br><span class="line">        count.compareAndSet(<span class="number">2</span>,<span class="number">4</span>);</span><br><span class="line">        <span class="comment">// 4/false</span></span><br><span class="line">        count.compareAndSet(<span class="number">3</span>,<span class="number">5</span>);</span><br><span class="line">        System.out.println(count.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>AtomicReferenceFieldUpdater</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample5 &#123;</span><br><span class="line"></span><br><span class="line">    @Getter</span><br><span class="line">    private volatile int count &#x3D; 100;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * AtomicIntegerFieldUpdater 核心是原子性的去更新某一个类的实例的指定的某一个字段</span><br><span class="line">     * 构造函数第一个参数为类定义，第二个参数为指定字段的属性名，必须是volatile修饰并且非static的字段</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static AtomicIntegerFieldUpdater&lt;AtomicExample5&gt; updater &#x3D; AtomicIntegerFieldUpdater.newUpdater(AtomicExample5.class,&quot;count&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        AtomicExample5 example5 &#x3D; new AtomicExample5();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 第一次 count&#x3D;100 -&gt; count-&gt;120 返回True</span><br><span class="line">        if(updater.compareAndSet(example5,100,120))&#123;</span><br><span class="line">            log.info(&quot;update success 1:&#123;&#125;&quot;,example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; count&#x3D;120 -&gt; 返回False</span><br><span class="line">        if(updater.compareAndSet(example5,100,120))&#123;</span><br><span class="line">            log.info(&quot;update success 2:&#123;&#125;&quot;,example5.getCount());</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            log.info(&quot;update field:&#123;&#125;&quot;,example5.getCount());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>4.AtomicStampReference:CAS的ABA问题</strong></p>
<p>ABA问题：在CAS操作的时候，其他线程将变量的值A改成了B由改成了A，本线程使用期望值A与当前变量进行比较的时候，发现A变量没有变，于是CAS就将A值进行了交换操作，这个时候实际上A值已经被其他线程改变过，这与设计思想是不符合的</p>
<p>解决思路：每次变量更新的时候，把变量的版本号加一，这样只要变量被某一个线程修改过，该变量版本号就会发生递增操作，从而解决了ABA变化</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Atomically sets the value of both the reference and stamp</span></span><br><span class="line"><span class="comment"> * to the given update values if the</span></span><br><span class="line"><span class="comment"> * current reference is &#123;<span class="doctag">@code</span> ==&#125; to the expected reference</span></span><br><span class="line"><span class="comment"> * and the current stamp is equal to the expected stamp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expectedReference the expected value of the reference</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newReference the new value for the reference</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expectedStamp the expected value of the stamp(上面提到的版本号)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newStamp the new value for the stamp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(V   expectedReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             V   newReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> expectedStamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> newStamp)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        expectedStamp == current.stamp &amp;&amp;</span><br><span class="line">        ((newReference == current.reference &amp;&amp;</span><br><span class="line">          newStamp == current.stamp) ||</span><br><span class="line">         casPair(current, Pair.of(newReference, newStamp)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>5.AtomicLongArray</strong></p>
<p>可以指定更新一个数组指定索引位置的值</p>
<p><strong>6.AtomicBoolean(平时用的比较多)</strong></p>
<p>compareAndSet方法也值得注意，可以达到同一时间只有一个线程执行这段代码</p>
<h2 id="4-2-原子性-synchronized"><a href="#4-2-原子性-synchronized" class="headerlink" title="4-2 原子性-synchronized"></a>4-2 原子性-synchronized</h2><ul>
<li><p>synchronized：依赖JVM （主要依赖JVM实现锁，因此在这个关键字作用对象的作用范围内，都是同一时刻只能有一个线程进行操作的）</p>
</li>
<li><p>Lock：依赖特殊的CPU指令，代码实现，ReentrantLock</p>
</li>
</ul>
<p>synchronized修饰内容分类</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修饰代码块</span><br><span class="line"></span><br><span class="line">修饰方法</span><br><span class="line"></span><br><span class="line">修饰静态方法</span><br><span class="line"></span><br><span class="line">修饰类</span><br></pre></td></tr></table></figure></div>


<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaowenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncronizedExample1</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修饰一个代码块，作用范围为大括号括起来的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                log.info(<span class="string">"test1-&#123;&#125;"</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改方法，作用范围是整个方法，作用对象为调用这个方法的对象</span></span><br><span class="line"><span class="comment">     * 若子类继承父类调用父类的synchronized方法，是带不上synchronized关键字的</span></span><br><span class="line"><span class="comment">     * 原因：synchronized 不属于方法声明的一部分</span></span><br><span class="line"><span class="comment">     * 如果子类也想使用同步需要在方法上声明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            log.info(<span class="string">"test2-&#123;&#125;"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncronizedExample1 example1 = <span class="keyword">new</span> SyncronizedExample1();</span><br><span class="line">        SyncronizedExample1 example2 = <span class="keyword">new</span> SyncronizedExample1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用线程池模拟一个对象的两个进程同时调用一段sync代码的执行过程</span></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程pool-1-thread-1,pool-1-thread-2 交叉输出</span></span><br><span class="line">        executorService.execute(()-&gt; example1.test1());</span><br><span class="line">        executorService.execute(()-&gt; example2.test1());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程pool-1-thread-1 先从0-9输出，然后pool-1-thread-2 从0到9顺序输出</span></span><br><span class="line">        <span class="comment">// executorService.execute(()-&gt; example1.test1());</span></span><br><span class="line">        <span class="comment">// executorService.execute(()-&gt; example1.test1());</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncronizedExample2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修饰类，括号包起来的代码</span></span><br><span class="line"><span class="comment">     * 作用对象为这个类的所有对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncronizedExample2<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                log.info(<span class="string">"test1-&#123;&#125;"</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修饰一个静态方法，作用对象为这个类的所有对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            log.info(<span class="string">"test2-&#123;&#125;"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncronizedExample2 example1 = <span class="keyword">new</span> SyncronizedExample2();</span><br><span class="line">        SyncronizedExample2 example2 = <span class="keyword">new</span> SyncronizedExample2();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用线程池模拟一个对象的两个进程同时调用一段sync代码的执行过程</span></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程pool-1-thread-1 先从0-9输出，然后pool-1-thread-2 从0到9顺序输出</span></span><br><span class="line">        executorService.execute(()-&gt; example1.test1());</span><br><span class="line">        executorService.execute(()-&gt; example1.test1());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程pool-1-thread-1 先从0-9输出，然后pool-1-thread-2 从0到9顺序输出</span></span><br><span class="line"><span class="comment">//        executorService.execute(()-&gt; example1.test2());</span></span><br><span class="line"><span class="comment">//        executorService.execute(()-&gt; example2.test2());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>原子性对比</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">synchronized: 不可中断锁，适合竞争不激烈，可读性好</span><br><span class="line"></span><br><span class="line">Lock: 可中断锁，多样化同步，竞争激烈时能维持常态</span><br><span class="line"></span><br><span class="line">Atomic: 竞争激烈时能维持常态，比Lock性能好；只能同步一个值</span><br></pre></td></tr></table></figure></div>

<h2 id="4-3-可见性"><a href="#4-3-可见性" class="headerlink" title="4-3 可见性"></a>4-3 可见性</h2><p>导致共享变量在线程中不可见的原因:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 线程交叉执行</span><br><span class="line">- 重排序结合线程交叉执行</span><br><span class="line">- 共享变量更新后的值没有在工作内存与主内存间及时更新</span><br></pre></td></tr></table></figure></div>



<p><strong>java提供了synchronized和volatile 两种方法来确保可见性</strong></p>
<p>JMM（java内存模型）关于synchronized的两条规定:</p>
<ul>
<li>线程解锁前，必须把共享变量的最新值刷新到主内存</li>
<li>线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新读取最新的值（注意，加锁和解锁是同一把锁）</li>
</ul>
<p>可见性-volatile：通过加入 <code>内存屏障</code>和禁止重排序优化来实现</p>
<ul>
<li><p>对volatile 变量写操作时，会在写操作后加入一条store屏障指令，将本地内存中的共享变量值刷新到主内存</p>
</li>
<li><p>对volatile变量读操作时，会在读操作前加入一条load屏障指令，从主内存中读取共享变量</p>
</li>
</ul>
<p>volatile写示意图<br><a href="/2018/07/28/15327607157902/15380405541117.jpg" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="/2018/07/28/15327607157902/15380405541117.jpg" class="lazyload"></a></p>
<p>volatile读示意图<br><a href="/2018/07/28/15327607157902/15380406640929.jpg" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="/2018/07/28/15327607157902/15380406640929.jpg" class="lazyload"></a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 并发测试</span><br><span class="line"> * @author gaowenfeng</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Slf4j</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class CountExample4 extends AbstractExample&#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;** 请求总数 *&#x2F;</span><br><span class="line">    public static int clientTotal &#x3D; 5000;</span><br><span class="line">    &#x2F;** 同时并发执行的线程数 *&#x2F;</span><br><span class="line">    public static int threadTotal &#x3D; 50;</span><br><span class="line"></span><br><span class="line">    public volatile static int count &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        new CountExample4().test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 本质上应该是这个方法线程不安全</span><br><span class="line">     *</span><br><span class="line">     * volatile只能保证 1，2，3的顺序不会被重排序</span><br><span class="line">     * 但是不保证1，2，3的原子执行，也就是说还是有可能有两个线程交叉执行1，导致结果不一致</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected void add() &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.取内存中的count值</span><br><span class="line">        &#x2F;&#x2F; 2.count值加1</span><br><span class="line">        &#x2F;&#x2F; 3.重新写会主存</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void countLog() &#123;</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;,count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>volatile使用条件</strong></p>
<p>1.对变量写操作不依赖于当前值<br>2.该变量没有包含在具有其他变量的不必要的式子中</p>
<p>综上，volatile特别适合用来做线程标记量，如下图</p>
<p><a href="/2018/07/28/15327607157902/15380408523633.jpg" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="/2018/07/28/15327607157902/15380408523633.jpg" class="lazyload"></a></p>
<p>  ​</p>
<h2 id="4-4-有序性"><a href="#4-4-有序性" class="headerlink" title="4-4 有序性"></a>4-4 有序性</h2><ul>
<li><p>Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到 单线程 程序的执行，却会影响到多线程并发执行的正确性。</p>
</li>
<li><p>保证有序性：volatile、synchronized、Lock</p>
</li>
</ul>
<p><strong>Happens-before原则</strong></p>
<blockquote>
<p>先天有序性，即不需要任何额外的代码控制即可保证有序性，java内存模型一个列出了八种Happens-before规则，如果两个操作的次序不能从这八种规则中推倒出来，则不能保证有序性（虚拟机可随意重排序）</p>
</blockquote>
<ol>
<li><p>程序次序规则：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作。</p>
<p>(这里只是程序的运行结果看起来像是顺序执行，虽然结果是一样的，jvm会对没有变量值依赖的操作进行重排序，这个规则只能保证单线程下执行的有序性，不能保证多线程下的有序性)</p>
</li>
</ol>
<ol start="2">
<li>锁定规则：一个unLock操作先行发生于后面对同一个锁的lock操作。</li>
<li>volatile变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作。</li>
<li>传递规则：如果操作A先行发生于操作B，而操作B又线性发生于操作C，则可以得出操作A先行发生于操作C。</li>
</ol>
<ol start="5">
<li>线程启动规则：Thread对象的start()方法先行发生于此线程的每一个动作。</li>
<li>线程中断规则：对现场interrupt()方法的调用先行发生于被中断线程的代码监测到到中断事件的发生。</li>
<li>线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法结束、Thread.isAlive()的返回值手段监测到线程已经终止执行。</li>
<li>对象终结规则：一个对象的初始化完成先行发生于他的finalize()方法的开始。</li>
</ol>
<h2 id="4-5-总结"><a href="#4-5-总结" class="headerlink" title="4-5 总结"></a>4-5 总结</h2><ul>
<li><p>原子性：Atomic包、CAS算法、synchronized、Lock</p>
</li>
<li><p>可见性：synchronized、volatile</p>
</li>
<li><p>有序性：happens-before</p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Machine</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://machine4869.gitee.io/2018/07/28/15327607157902/">https://machine4869.gitee.io/2018/07/28/15327607157902/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://machine4869.gitee.io">哑舍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">Java并发编程与高并发解决方案    </a></div><div class="post_share"><div class="social-share" data-image="/img/default_p9.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2018/08/09/15338173277136/"><img class="prev_cover lazyload" data-src="/img/default_p9.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>ES6新特征（基本+常用）</span></div></a></div><div class="next-post pull_right"><a href="/2018/07/28/15327623035290/"><img class="next_cover lazyload" data-src="/img/default_p10.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>使用git将初始化代码托管到-项目初始化</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/11/05/20181105165724309/" title="高并发解决方案（4）：数据库切库分库分表&高可用"><img class="relatedPosts_cover lazyload"data-src="/img/default_p5.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-05</div><div class="relatedPosts_title">高并发解决方案（4）：数据库切库分库分表&高可用</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/05/20181105104407665/" title="高并发解决方案（3）：应用限流&服务降级与服务熔断"><img class="relatedPosts_cover lazyload"data-src="/img/default_p3.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-05</div><div class="relatedPosts_title">高并发解决方案（3）：应用限流&服务降级与服务熔断</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/03/20181103212110299/" title="高并发解决方案（2）：消息队列&应用拆分"><img class="relatedPosts_cover lazyload"data-src="/img/default_p8.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-03</div><div class="relatedPosts_title">高并发解决方案（2）：消息队列&应用拆分</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/31/20181031100154042/" title="高并发解决方案（1）：扩容&缓存"><img class="relatedPosts_cover lazyload"data-src="/img/default_p4.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-31</div><div class="relatedPosts_title">高并发解决方案（1）：扩容&缓存</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/30/20181030111752438/" title="并发编程与线程安全（6）：线程池 Executor&并发拓展"><img class="relatedPosts_cover lazyload"data-src="/img/default_p6.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-30</div><div class="relatedPosts_title">并发编程与线程安全（6）：线程池 Executor&并发拓展</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/29/20181029185403603/" title="并发编程与线程安全（5）：J.U.C组件拓展"><img class="relatedPosts_cover lazyload"data-src="/img/default_p2.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-29</div><div class="relatedPosts_title">并发编程与线程安全（5）：J.U.C组件拓展</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = true == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yPVvDIaWlODDhs0bbECwLIIp-gzGzoHsz',
  appKey:'VyOIa40LxnjURzW1HUCiwTpV',
  placeholder:'记得留下你的昵称及邮箱，以便收到答复~',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Machine</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://machine4869.gitee.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="canvas_nest" color="215,215,215" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>